<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,viewport-fit=cover">
<title>AR Breathing Guide â€” Lotus</title>
<style>
/* CSS Styling */
html,body{height:100%;margin:0;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial;background:#000}
#uiTop{position:fixed;left:12px;top:12px;color:#fff;z-index:11}
/* Kontrol di-hide saat load, akan ditampilkan saat AR dimulai */
#controls{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;display:flex;gap:10px;z-index:11; display:none;} 
.btn{padding:10px 14px;border-radius:12px;border:0;background:#fff;font-weight:700}
#phase{position:fixed;left:50%;transform:translateX(-50%);top:78px;background:rgba(0,0,0,0.6);color:#00ff88;padding:8px 14px;border-radius:20px;z-index:11;font-weight:800}
#loader{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.6);color:white;padding:10px 14px;border-radius:8px;z-index:20;display:none}
footer{position:fixed;left:12px;bottom:12px;color:#aaa;font-size:12px}
/* Untuk visualisasi fase pernapasan (opsional) */
.inhaling{color:#00ff88;}
.exhaling{color:#ff8800;} 
</style>
</head>
<body>
<div id="uiTop"><strong>Breathing Guide â€” Lotus</strong></div>
<div id="phase">INHALE</div>
<div id="loader">Loading modelâ€¦</div>

<div id="controls">
Â  <button class="btn" id="pauseBtn">â¸ Pause</button>
Â  <button class="btn" id="slower">âª Slower</button>
Â  <button class="btn" id="faster">â© Faster</button>
Â  <button class="btn" id="audioBtn">ğŸ”ˆ Audio</button>
</div>

<audio id="breathAudio" src="assets/breathing.mp3" preload="auto"></audio>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
import { ARButton } from 'https://unpkg.com/three@0.160.0/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer, pivot, flower;
let clock = new THREE.Clock();
let isPaused = false;
let speed = 1.0;
let phase = 'inhale';
const loader = new GLTFLoader();

init();
function init(){
Â  const container = document.createElement('div'); document.body.appendChild(container);
Â  scene = new THREE.Scene();
Â  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

Â  renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
Â  renderer.setPixelRatio(window.devicePixelRatio); renderer.setSize(window.innerWidth, window.innerHeight);
Â  renderer.xr.enabled = true; renderer.xr.setReferenceSpaceType('local');
Â  container.appendChild(renderer.domElement);

Â  const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1); scene.add(light);
Â  const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(0.5,1,0.25).normalize(); scene.add(dir);

Â  // --- PERBAIKAN: ARButton Dibuat di sini dan akan Memicu Izin Kamera ---
Â  document.body.appendChild(ARButton.createButton(renderer, { 
Â  Â  requiredFeatures: ['hit-test'], 
Â  Â  optionalFeatures: ['dom-overlay'], 
Â  Â  domOverlay: { root: document.body } 
Â  }));

Â  pivot = new THREE.Group(); pivot.position.set(0,0,-1); scene.add(pivot);

Â  setupGestures(renderer.domElement);
Â  window.addEventListener('resize', ()=>{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });

Â  // load flower model
Â  document.getElementById('loader').style.display = 'block';
Â  loader.load('assets/flower.glb', gltf => {
Â  Â  flower = gltf.scene;
Â  Â  scaleToHeight(flower, 0.35);
Â  Â  pivot.add(flower);
Â  Â  flower.position.set(0,-0.15,0);
Â  Â  document.getElementById('loader').style.display = 'none';
Â  Â  
Â  Â  // Opsional: Tampilkan controls segera setelah model dimuat (jika AR belum dimulai)
Â  Â  // document.getElementById('controls').style.display = 'flex'; 
Â  }, undefined, err => {
Â  Â  console.error(err);
Â  Â  document.getElementById('loader').textContent = 'Failed to load flower.glb';
Â  });

Â  // --- PERBAIKAN UTAMA: Mengaktifkan Audio dan UI saat Sesi AR Dimulai ---
Â  renderer.xr.addEventListener('sessionstart', () => {
Â  Â  // Tampilkan kontrol UI
Â  Â  document.getElementById('controls').style.display = 'flex';
Â  Â  
Â  Â  // Putar Audio (Memanfaatkan interaksi pengguna yang sudah terjadi)
Â  Â  const audio = document.getElementById('breathAudio');
Â  Â  audio.play().catch(()=>{});
Â  Â  // Setting _enabled untuk kontrol tombol audio
Â  Â  audio._enabled = true; 
Â  });

Â  // Opsional: Bersihkan UI saat sesi AR berakhir
Â  renderer.xr.addEventListener('sessionend', () => {
Â  Â  document.getElementById('controls').style.display = 'none';
Â  Â  document.getElementById('breathAudio').pause();
Â  Â  isPaused = true;
Â  Â  pauseBtn.textContent = 'â–¶ Resume';
Â  });


Â  renderer.setAnimationLoop(render);
}

function render(){
Â  if (renderer.xr.isPresenting){
Â  Â  const cam = renderer.xr.getCamera(camera);
Â  Â  const camWorld = new THREE.Vector3(); cam.getWorldPosition(camWorld);
Â  Â  const camDir = new THREE.Vector3(0,0,-1).applyQuaternion(cam.quaternion);
Â  Â  const desiredPos = camWorld.clone().add(camDir.multiplyScalar(1.0));
Â  Â  pivot.position.copy(desiredPos);
Â  Â  pivot.quaternion.copy(cam.quaternion);
Â  } else {
Â  Â  // Jika AR belum dimulai, objek tetap di depan kamera non-AR
Â  Â  pivot.position.set(0,0,-1); pivot.quaternion.identity();
Â  }

Â  if (flower && !isPaused){
Â  Â  const t = clock.getElapsedTime() * speed;
Â  Â  // breathing scale animation (inhale/exhale)
Â  Â  const s = 1 + 0.08 * Math.sin(t * Math.PI); 
Â  Â  flower.scale.setScalar(s);
Â  Â  
Â  Â  // determine phase (inhale/exhale) by sign of sin
Â  Â  const sinv = Math.sin(t * Math.PI);
Â  Â  const newPhase = sinv > 0.01 ? 'inhale' : (sinv < -0.01 ? 'exhale' : phase); // Hindari perubahan cepat di titik 0
Â  Â  if (newPhase !== phase){ phase = newPhase; updatePhaseUI(); }
Â  }

Â  renderer.render(scene, camera);
}

function scaleToHeight(obj, meters){
Â  const box = new THREE.Box3().setFromObject(obj);
Â  const size = new THREE.Vector3(); box.getSize(size);
Â  if (size.y > 0){ const s = meters / size.y; obj.scale.setScalar(s); }
}

function updatePhaseUI(){
Â  const el = document.getElementById('phase');
Â  el.textContent = phase.toUpperCase();
Â  el.className = phase === 'inhale' ? 'inhaling' : 'exhaling';
}

// basic gesture handlers (rotate, translate, pinch)
let ongoing = { prevDist:0, prevMid:null, lastSingle:null, isPointerDown:false, scaleFactor:1 };
function setupGestures(dom){
Â  dom.addEventListener('touchstart', e => { if (!flower) return; e.preventDefault(); const t = e.touches; if (t.length === 1){ ongoing.lastSingle={x:t[0].clientX,y:t[0].clientY}; ongoing.isPointerDown=true; } else if (t.length===2){ ongoing.prevDist = dist(t[0],t[1]); ongoing.prevMid = mid(t[0],t[1]); } }, {passive:false});
Â  dom.addEventListener('touchmove', e => { if (!flower) return; e.preventDefault(); const t = e.touches; if (t.length===1 && ongoing.isPointerDown){ const p={x:t[0].clientX,y:t[0].clientY}; const dx = p.x - ongoing.lastSingle.x; const dy = p.y - ongoing.lastSingle.y; flower.rotation.y += dx*0.005; flower.rotation.x += dy*0.005; ongoing.lastSingle = p; } else if (t.length===2){ const nd = dist(t[0],t[1]); const nmid = mid(t[0],t[1]); const sf = nd/(ongoing.prevDist||nd); ongoing.scaleFactor *= sf; flower.scale.setScalar(ongoing.scaleFactor); ongoing.prevDist = nd; if (ongoing.prevMid){ const mdx = nmid.x - ongoing.prevMid.x; const mdy = nmid.y - ongoing.prevMid.y; const factor = 0.0016; pivot.position.x += -mdx * factor; pivot.position.y += mdy * factor; } ongoing.prevMid = nmid; } }, {passive:false});
Â  dom.addEventListener('touchend', e => { ongoing.isPointerDown=false; ongoing.prevDist=0; ongoing.prevMid=null; }, {passive:false});
}
function mid(a,b){ return {x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2}; }
// --- PERBAIKAN BUG: Perbaikan typo di b.clientClientX ---
function dist(a,b){ const dx=a.clientX-b.clientX; const dy=a.clientY-b.clientY; return Math.hypot(dx,dy); } 

// controls: pause, speed, audio
const pauseBtn = document.getElementById('pauseBtn');
const sBtn = document.getElementById('slower');
const fBtn = document.getElementById('faster');
const aBtn = document.getElementById('audioBtn');
const audio = document.getElementById('breathAudio');

pauseBtn.addEventListener('click', ()=>{
Â  isPaused = !isPaused;
Â  pauseBtn.textContent = isPaused ? 'â–¶ Resume' : 'â¸ Pause';
Â  // Pastikan audio hanya dimainkan jika AR tidak di-pause DAN audio diaktifkan
Â  if (isPaused) audio.pause(); else if (audio._enabled) audio.play().catch(()=>{}); 
});
sBtn.addEventListener('click', ()=>{ speed = Math.max(0.5, speed - 0.25); });
fBtn.addEventListener('click', ()=>{ speed = Math.min(2.0, speed + 0.25); });
aBtn.addEventListener('click', ()=>{
Â  audio._enabled = !audio._enabled;
Â  aBtn.textContent = audio._enabled ? 'ğŸ”Š Audio' : 'ğŸ”‡ Audio OFF';
Â  if (audio._enabled && !isPaused) audio.currentTime = 0, audio.play().catch(()=>{});
Â  else audio.pause();
});

// Setting default audio state for control (hanya untuk internal tracking)
audio._enabled = true;

</script>
<footer>Tip: Use Chrome (Android) for best WebXR support. Allow camera access when prompted.</footer>
</body>
</html>
